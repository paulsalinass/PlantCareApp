@page "/plants/{Id:int}"
@rendermode InteractiveServer

@inject PlantService PlantService
@inject WeatherService WeatherService
@inject PlantTimelineService TimelineService
@inject RecommendationService RecommendationService
@inject CareAutomationService AutomationService

<div class="plant-detail-header mb-4 d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
    <div>
        <h1 class="mb-1 fw-semibold">Ficha de cuidado</h1>
        <p class="text-muted mb-0">Información y recomendaciones para tu planta.</p>
    </div>
    <div class="d-flex gap-2">
        <NavLink class="btn btn-outline-secondary" href="/plants">Volver</NavLink>
        <NavLink class="btn btn-primary" href="@($"/plants/edit/{Id}")">Editar</NavLink>
    </div>
</div>

@if (isLoading)
{
    <p>Cargando...</p>
}
else if (plant is null)
{
    <div class="alert alert-warning">No encontramos la planta solicitada. <NavLink href="/plants">Volver</NavLink></div>
}
else
{
    <div class="row g-4">
        <div class="col-12 col-lg-5">
            <div class="plant-detail-card hero h-100">
                <img src="@GetPhoto(plant)" alt="@plant.Name" class="detail-hero-img" />
                <div class="mt-3">
                    <h2 class="h4 mb-1">@plant.Name</h2>
                    <p class="text-muted">@plant.Species</p>
                </div>

                <div class="detail-stats mt-3">
                    <div class="stat-chip">
                        <small>Zona</small>
                        <span>@(string.IsNullOrWhiteSpace(plant.LocationArea) ? "Sin dato" : plant.LocationArea)</span>
                    </div>
                    <div class="stat-chip">
                        <small>Ambiente</small>
                        <span>@(plant.IsIndoors ? "Interior" : "Exterior")</span>
                    </div>
                    <div class="stat-chip">
                        <small>Próximo riego</small>
                        <span>@(plant.NextWateringDate?.ToString("dd/MM") ?? "Sin programar")</span>
                    </div>
                </div>

                <div class="detail-list mt-3">
                    <div>
                        <small class="text-muted">Ubicación</small>
                        <p class="mb-0">
                            @(string.IsNullOrWhiteSpace(plant.LocationName) ? "Sin especificar" : plant.LocationName)
                            @if (!string.IsNullOrWhiteSpace(plant.Country))
                            {
                                <span>, @plant.Country</span>
                            }
                        </p>
                    </div>
                    <div>
                        <small class="text-muted">Horas de sol</small>
                        <p class="mb-0">@(plant.EstimatedSunHours?.ToString() ?? "N/A") h</p>
                    </div>
                    <div>
                        <small class="text-muted">Notas</small>
                        <p class="mb-0">@(string.IsNullOrWhiteSpace(plant.Notes) ? "Sin notas." : plant.Notes)</p>
                    </div>
                </div>

                <div class="climate-card mt-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <strong>Clima actual</strong>
                        @if (HasCoordinates)
                        {
                            <span class="text-muted">@(plant.Latitude?.ToString("F2") ?? "--") / @(plant.Longitude?.ToString("F2") ?? "--")</span>
                        }
                    </div>
                    @if (!HasCoordinates)
                    {
                        <p class="text-muted mb-0">Agrega latitud y longitud para mostrar los datos del clima.</p>
                    }
                    else if (weatherError is not null)
                    {
                        <p class="text-muted mb-0">@weatherError</p>
                    }
                    else if (weather is null)
                    {
                        <p class="mb-0">Consultando clima...</p>
                    }
                    else
                    {
                        <div class="d-flex align-items-center gap-4">
                            <div>
                                <div class="climate-temp">@weather.Current.TemperatureC &deg;C</div>
                                <small class="text-muted">@weather.Current.Conditions</small>
                            </div>
                            <div class="text-muted small">
                                <div>Humedad: <strong>@weather.Current.Humidity %</strong></div>
                                <div>Viento: <strong>@weather.Current.WindSpeedKph km/h</strong></div>
                                <div>Actualizado: @weather.Current.RetrievedAt.ToLocalTime().ToShortTimeString()</div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="col-12 col-lg-7">
            <div class="detail-tabs">
                <button class='@GetTabClass("description")' @onclick='() => ActivateTab("description")'>Descripción</button>
                <button class='@GetTabClass("care")' @onclick='() => ActivateTab("care")'>Cuidado</button>
                <button class='@GetTabClass("history")' @onclick='() => ActivateTab("history")'>Historial</button>
            </div>

            @if (activeTab == "description")
            {
                <div class="info-block">
                    @foreach (var block in infoBlocks)
                    {
                        <div class="info-section">
                            <h5>@block.Title</h5>
                            <p>@block.Content</p>
                        </div>
                    }
                </div>

                <div class="row g-3 mt-3">
                    @foreach (var req in requirements)
                    {
                        <div class="col-12 col-md-6">
                            <div class="requirement-card">
                                <div class="requirement-icon">
                                    <i class="@req.Icon"></i>
                                </div>
                                <div>
                                    <p class="fw-semibold mb-1">@req.Title</p>
                                    <p class="text-muted mb-0">@req.Detail</p>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            else if (activeTab == "care")
            {
                <div class="row g-3">
                    @foreach (var tip in careTips)
                    {
                        <div class="col-12">
                            <div class="care-card">
                                <div class="care-icon @tip.CssClass">
                                    <i class="@tip.Icon"></i>
                                </div>
                                <div>
                                    <p class="fw-semibold mb-1">@tip.Title</p>
                                    <p class="text-muted mb-0">@tip.Description</p>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            else if (activeTab == "history")
            {
                <div class="history-grid">
                    <div class="history-card">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">Galería</h5>
                            <small class="text-muted">@($"{plant.Photos.Count} fotos")</small>
                        </div>
                        <div class="gallery-grid">
                            <label class="gallery-add">
                                <InputFile OnChange="OnPhotoSelected" accept="image/*" />
                                <div>
                                    <i class="bi bi-image"></i>
                                    <p class="mb-0">Agregar foto</p>
                                    @if (isUploadingPhoto)
                                    {
                                        <small>Cargando...</small>
                                    }
                                </div>
                            </label>
                            @foreach (var photo in plant.Photos.OrderByDescending(p => p.TakenAt))
                            {
                                <button type="button" class="gallery-thumb" @onclick="() => OpenPhoto(photo)">
                                    <img src="@photo.FilePath" alt="Foto @plant.Name" />
                                </button>
                            }
                        </div>
                    </div>
                    <div class="history-card">
                        <h5 class="mb-3">Notas rápidas</h5>
                        <textarea class="form-control mb-2"
                                  rows="3"
                                  placeholder="Escribe una nota sobre el cuidado de tu planta..."
                                  @bind="newNote"></textarea>
                        <button class="btn btn-primary" type="button" @onclick="SubmitNoteAsync" disabled="@isSavingNote">
                            @(isSavingNote ? "Guardando..." : "Guardar nota")
                        </button>
                    </div>
                </div>

                @if (automationInsights.Count > 0)
                {
                    <div class="history-card ai-card">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="mb-0">Automatización de cuidados</h5>
                            <small class="text-muted">Basado en clima e historial</small>
                        </div>
                        <ul class="list-unstyled mb-0">
                            @foreach (var insight in automationInsights)
                            {
                                <li class="ai-item">
                                    <strong><i class="@insight.Icon me-1"></i>@insight.Title</strong>
                                    <p class="mb-0 text-muted">@insight.Description</p>
                                </li>
                            }
                        </ul>
                    </div>
                }

                @if (lightboxPhoto is not null)
                {
                    <div class="lightbox-overlay" @onclick="CloseLightbox">
                        <div class="lightbox-body" @onclick:stopPropagation="true">
                            <button type="button" class="btn-close btn-close-white" aria-label="Cerrar" @onclick="CloseLightbox"></button>
                            <img src="@lightboxPhoto.FilePath" alt="Foto ampliada" />
                            @if (!string.IsNullOrWhiteSpace(lightboxPhoto.AnalysisSummary))
                            {
                                <p class="text-muted mt-2">@lightboxPhoto.AnalysisSummary</p>
                            }
                            <div class="d-flex gap-2 mt-3">
                                <button class="btn btn-danger" type="button" @onclick="DeleteLightboxPhotoAsync" disabled="@isDeletingPhoto">
                                    @(isDeletingPhoto ? "Eliminando..." : "Eliminar foto")
                                </button>
                                <button class="btn btn-outline-light" type="button" @onclick="CloseLightbox">Cerrar</button>
                            </div>
                        </div>
                    </div>
                }

                <div class="timeline-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">Hoy</h5>
                        @if (isTimelineLoading)
                        {
                            <small class="text-muted">Cargando historial...</small>
                        }
                    </div>
                    @if (!string.IsNullOrEmpty(timelineError))
                    {
                        <div class="alert alert-warning">@timelineError</div>
                    }
                    else if (timelineEvents.Count == 0)
                    {
                        <p class="text-muted mb-0">Aún no hay registros. Agrega una nota o una foto para iniciar el historial.</p>
                    }
                    else
                    {
                        <div class="timeline-list">
                            @foreach (var evt in timelineEvents)
                            {
                                <div class="timeline-item">
                                    <div class="timeline-icon @GetEventAccent(evt)">
                                        <i class="@GetEventIcon(evt)"></i>
                                    </div>
                                    <div class="timeline-body">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <strong>@evt.Title</strong>
                                                @if (!string.IsNullOrWhiteSpace(evt.Description))
                                                {
                                                    <p class="mb-1 text-muted">@evt.Description</p>
                                                }
                                            </div>
                                            <small class="text-muted">@FormatEventTime(evt.CreatedAt)</small>
                                        </div>
                                        @if (!string.IsNullOrEmpty(evt.Photo?.FilePath))
                                        {
                                            <img src="@evt.Photo.FilePath" class="timeline-photo" alt="Foto evento" />
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            }
        </div>
    </div>
}

@code {
    [Parameter] public int Id { get; set; }
    [SupplyParameterFromQuery] public string? Tab { get; set; }

    private Plant? plant;
    private WeatherInfo? weather;
    private bool isLoading = true;
    private string? weatherError;
    private string activeTab = "description";
    private readonly List<CareTip> careTips = new();
    private readonly List<RequirementTip> requirements = new();
    private readonly List<InfoBlock> infoBlocks = new();
    private readonly List<PlantTimelineEvent> timelineEvents = new();
    private readonly List<CareRecommendation> timelineSuggestions = new();
    private readonly List<CareAutomationInsight> automationInsights = new();
    private bool isTimelineLoading;
    private string? timelineError;
    private string? newNote;
    private bool isSavingNote;
    private bool isUploadingPhoto;
    private PlantPhoto? lightboxPhoto;
    private bool isDeletingPhoto;

    private bool HasCoordinates => plant?.Latitude is not null && plant.Longitude is not null;

    protected override async Task OnInitializedAsync()
    {
        plant = await PlantService.GetPlantAsync(Id);
        isLoading = false;

        if (plant is not null)
        {
            BuildCarePlan();
        }

        if (HasCoordinates)
        {
            try
            {
                weather = await WeatherService.GetCurrentWeatherAsync(
                    plant!.Latitude!.Value,
                    plant.Longitude!.Value,
                    plant.LocationName ?? plant.Country ?? plant.Name);
            }
            catch (Exception ex)
            {
                weatherError = ex.Message;
            }
        }

        await LoadTimelineAsync();
    }

    protected override void OnParametersSet()
    {
        if (!string.IsNullOrWhiteSpace(Tab))
        {
            activeTab = Tab!;
        }
    }

    private void BuildCarePlan()
    {
        careTips.Clear();
        requirements.Clear();
        infoBlocks.Clear();

        var watering = plant!.WateringFrequencyDays ?? 7;
        careTips.Add(new CareTip("Frecuencia de riego", $"Riega cada {watering} día(s) o cuando la capa superior esté seca.", "bi bi-droplet", "watering"));
        careTips.Add(new CareTip("Nutrientes", "Abona con fertilizante líquido balanceado cada 4-6 semanas en temporada de crecimiento.", "bi bi-bag-heart", "fertilizing"));
        careTips.Add(new CareTip("Poda ligera", "Retira hojas amarillas o dañadas para mantener el follaje sano.", "bi bi-scissors", "care"));

        requirements.Add(new RequirementTip("Maceta", "Usa maceta con buen drenaje y 2 cm extra de diámetro.", "bi bi-flower3"));
        requirements.Add(new RequirementTip("Suelo", "Sustrato aireado con perlita o fibra de coco.", "bi bi-layers"));
        requirements.Add(new RequirementTip("Iluminación", plant.EstimatedSunHours is null ? "Luz brillante indirecta." : $"{plant.EstimatedSunHours} h de luz filtrada.", "bi bi-brightness-high"));
        requirements.Add(new RequirementTip("Humedad", plant.IsIndoors ? "Prefiere humedad media (>50%). Pulveriza en climas secos." : "Vigila el exceso de calor y viento directo.", "bi bi-moisture"));

        infoBlocks.Add(new InfoBlock("Descripción general",
            $"Especie: {plant.Species}. Ubicación propuesta: {(string.IsNullOrWhiteSpace(plant.LocationName) ? "sin definir" : plant.LocationName)}. Recuerda registrar cada riego/fertilización para ajustar el plan."));
        infoBlocks.Add(new InfoBlock("Recomendaciones especiales",
            "Evita encharcar la base. Limpia las hojas para facilitar la fotosíntesis y revisa plagas como cochinillas o ácaros."));
    }

    private void ActivateTab(string tab) => activeTab = tab;

    private string GetTabClass(string tab) => $"detail-tab {(activeTab == tab ? "active" : string.Empty)}";

    private static string GetPhoto(Plant plant)
    {
        if (!string.IsNullOrEmpty(plant.MainPhotoPath))
        {
            return plant.MainPhotoPath.StartsWith("/", StringComparison.Ordinal) ? plant.MainPhotoPath : "/" + plant.MainPhotoPath;
        }

        return "/images/placeholder.svg";
    }

    private async Task LoadTimelineAsync()
    {
        if (plant is null)
        {
            return;
        }

        try
        {
            isTimelineLoading = true;
            timelineError = null;
            timelineEvents.Clear();
            var events = await TimelineService.GetTimelineAsync(plant.Id);
            timelineEvents.AddRange(events);
            timelineSuggestions.Clear();
            timelineSuggestions.AddRange(RecommendationService.GetTimelineInsights(plant, timelineEvents));
            automationInsights.Clear();
            var weatherInfo = HasCoordinates
                ? await TryGetWeatherAsync(plant.Latitude!.Value, plant.Longitude!.Value)
                : weather;
            var auto = await AutomationService.BuildInsightsAsync(plant, weatherInfo, timelineEvents);
            automationInsights.AddRange(auto);
        }
        catch (Exception ex)
        {
            timelineError = ex.Message;
        }
        finally
        {
            isTimelineLoading = false;
        }
    }

    private async Task<WeatherInfo?> TryGetWeatherAsync(double lat, double lon)
    {
        try
        {
            return await WeatherService.GetCurrentWeatherAsync(lat, lon, plant?.LocationName ?? plant?.Country ?? "Ubicacion");
        }
        catch
        {
            return null;
        }
    }

    private async Task SubmitNoteAsync()
    {
        if (plant is null || string.IsNullOrWhiteSpace(newNote) || isSavingNote)
        {
            return;
        }

        try
        {
            isSavingNote = true;
            timelineError = null;
            var evt = await TimelineService.AddNoteAsync(plant.Id, newNote.Trim());
            PrependTimelineEvent(evt);
            newNote = string.Empty;
        }
        catch (Exception ex)
        {
            timelineError = ex.Message;
        }
        finally
        {
            isSavingNote = false;
        }
    }

    private async Task OnPhotoSelected(InputFileChangeEventArgs args)
    {
        if (plant is null || args.File is null || isUploadingPhoto)
        {
            return;
        }

        try
        {
            isUploadingPhoto = true;
            timelineError = null;
            var evt = await TimelineService.AddPhotoAsync(plant.Id, args.File);
            PrependTimelineEvent(evt);
            if (evt.Photo is not null)
            {
                plant.Photos.Add(evt.Photo);
            }
        }
        catch (Exception ex)
        {
            timelineError = ex.Message;
        }
        finally
        {
            isUploadingPhoto = false;
        }
    }

    private void PrependTimelineEvent(PlantTimelineEvent evt)
    {
        timelineEvents.Insert(0, evt);
    }

    private void OpenPhoto(PlantPhoto photo)
    {
        lightboxPhoto = photo;
    }

    private void CloseLightbox()
    {
        lightboxPhoto = null;
    }

    private async Task DeleteLightboxPhotoAsync()
    {
        if (lightboxPhoto is null || isDeletingPhoto)
        {
            return;
        }

        try
        {
            isDeletingPhoto = true;
            await TimelineService.DeletePhotoAsync(lightboxPhoto.Id);

            if (plant is not null)
            {
                var photo = plant.Photos.FirstOrDefault(p => p.Id == lightboxPhoto.Id);
                if (photo is not null)
                {
                    plant.Photos.Remove(photo);
                }
            }

            timelineEvents.RemoveAll(e => e.PhotoId == lightboxPhoto.Id);
            lightboxPhoto = null;
        }
        catch (Exception ex)
        {
            timelineError = ex.Message;
        }
        finally
        {
            isDeletingPhoto = false;
        }
    }

    private static string GetEventIcon(PlantTimelineEvent evt) =>
        string.IsNullOrWhiteSpace(evt.Icon) ? "bi bi-leaf" : evt.Icon!;

    private static string GetEventAccent(PlantTimelineEvent evt) =>
        string.IsNullOrWhiteSpace(evt.AccentCss) ? "pill-neutral" : evt.AccentCss!;

    private static string FormatEventTime(DateTime dateTime) =>
        dateTime.ToLocalTime().ToString("HH:mm · dd MMM");

    private record CareTip(string Title, string Description, string Icon, string CssClass);
    private record RequirementTip(string Title, string Detail, string Icon);
    private record InfoBlock(string Title, string Content);
}


