@page "/plants/edit/{Id:int}"
@rendermode InteractiveServer
@implements IAsyncDisposable

@inject PlantService PlantService
@inject ImageStorageService ImageStorageService
@inject NavigationManager Navigation
@inject IJSRuntime Js
@inject LocationLookupService LocationLookupService
@inject HomeZoneService HomeZoneService
@using System.IO

<h1 class="mb-4">Editar planta</h1>

@if (isLoading)
{
    <p>Cargando...</p>
}
else if (plant is null)
{
    <div class="alert alert-warning">
        No se encontró la planta solicitada. <NavLink href="/plants">Volver</NavLink>
    </div>
}
else
{
    if (!string.IsNullOrEmpty(formError))
    {
        <div class="alert alert-danger">@formError</div>
    }

    <EditForm Model="@plant" OnValidSubmit="@HandleValidSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="row g-4">
            <div class="col-12 col-lg-7">
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Información básica</h5>

                        <div class="mb-3">
                            <label class="form-label">Nombre</label>
                            <InputText class="form-control" @bind-Value="plant.Name" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Especie</label>
                            <InputText class="form-control" @bind-Value="plant.Species" />
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Ciudad</label>
                                <InputText class="form-control" @bind-Value="plant.LocationName" readonly="@(!isLocationEditable)" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">País</label>
                                <InputText class="form-control" @bind-Value="plant.Country" readonly="@(!isLocationEditable)" />
                            </div>
                        </div>
                        <button type="button" class="btn btn-link btn-sm p-0 mb-2" @onclick="ToggleLocationEditable">
                            @(isLocationEditable ? "Bloquear campos" : "Editar manualmente")
                        </button>

                        <div class="mb-3">
                            <label class="form-label">Zona en el hogar</label>
                            <input class="form-control" list="zoneSuggestionsEdit" @bind="plant.LocationArea" placeholder="Ej. Sala, Patio, Balcón" />
                            <datalist id="zoneSuggestionsEdit">
                                @foreach (var zone in zoneOptions)
                                {
                                    <option value="@zone"></option>
                                }
                            </datalist>
                            <div class="d-flex justify-content-between align-items-center mt-1">
                                <small class="text-muted">Agrupa tus plantas por ambientes.</small>
                                <button type="button" class="btn btn-link btn-sm p-0" @onclick="ToggleZoneManager">
                                    @(showZoneManager ? "Cerrar gestor" : "Administrar zonas")
                                </button>
                            </div>
                            @if (showZoneManager)
                            {
                                <div class="card border-0 shadow-sm mt-2 zone-manager">
                                    <div class="card-body">
                                        <div class="input-group input-group-sm mb-2">
                                            <input class="form-control" placeholder="Nueva zona" @bind="newZoneName" />
                                            <button type="button" class="btn btn-success" @onclick="AddCustomZoneAsync" disabled="@isZoneOperation">
                                                @(isZoneOperation ? "Guardando..." : "Agregar")
                                            </button>
                                        </div>
                                        <div class="zone-list">
                                            @foreach (var zone in zoneOptions.OrderBy(z => z))
                                            {
                                                var isDefault = defaultZoneSet.Contains(zone);
                                                <span class="zone-chip">
                                                    @zone
                                                    @if (!isDefault)
                                                    {
                                                        <button type="button" class="btn-close btn-close-white ms-1" aria-label="Quitar" @onclick="() => RemoveZoneAsync(zone)" disabled="@isZoneOperation"></button>
                                                    }
                                                </span>
                                            }
                                        </div>
                                        @if (!string.IsNullOrEmpty(zoneError))
                                        {
                                            <div class="alert alert-warning mb-0 mt-3 small">@zoneError</div>
                                        }
                                    </div>
                                </div>
                            }
                        </div>

                        <div class="mb-3 location-search">
                            <label class="form-label">Buscar ciudad</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <InputText class="form-control" placeholder="Ej. Piura, Lima, Cusco" @bind-Value="locationSearch" />
                                <button class="btn btn-outline-secondary" type="button" disabled="@isSearchingLocation" @onclick="SearchLocationAsync">
                                    @(isSearchingLocation ? "Buscando..." : "Buscar")
                                </button>
                            </div>
                            @if (!string.IsNullOrEmpty(locationSearchError))
                            {
                                <div class="text-danger small mt-1">@locationSearchError</div>
                            }
                            @if (locationResults.Count > 0)
                            {
                                <div class="list-group mt-2 location-results">
                                    @foreach (var suggestion in locationResults)
                                    {
                                        <button type="button" class="list-group-item list-group-item-action" @onclick="() => ApplyLocation(suggestion)">
                                            <div class="fw-semibold">@suggestion.Name</div>
                                            <div class="text-muted small">
                                                @(string.IsNullOrWhiteSpace(suggestion.Country) ? "Sin país" : suggestion.Country)
                                                @if (!string.IsNullOrWhiteSpace(suggestion.Timezone))
                                                {
                                                    <span> · @suggestion.Timezone</span>
                                                }
                                                <span> · @suggestion.Latitude.ToString("F2"), @suggestion.Longitude.ToString("F2")</span>
                                            </div>
                                        </button>
                                    }
                                </div>
                            }
                        </div>

                        <div class="form-check form-switch mb-3">
                            <InputCheckbox class="form-check-input" @bind-Value="plant.IsIndoors" />
                            <label class="form-check-label">Interior</label>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Horas de sol estimadas</label>
                                <InputNumber TValue="int?" class="form-control" @bind-Value="plant.EstimatedSunHours" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Frecuencia de riego (días)</label>
                                <InputNumber TValue="int?" class="form-control" @bind-Value="plant.WateringFrequencyDays" />
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Último riego</label>
                                <InputDate TValue="DateTime?" class="form-control" @bind-Value="plant.LastWateredAt" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Notas</label>
                                <InputTextArea class="form-control" @bind-Value="plant.Notes" rows="3" />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm border-0">
                    <div class="card-body">
                        <h5 class="card-title">Ubicación precisa</h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Latitud</label>
                                <InputNumber TValue="double?" class="form-control" @bind-Value="plant.Latitude" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Longitud</label>
                                <InputNumber TValue="double?" class="form-control" @bind-Value="plant.Longitude" />
                            </div>
                        </div>

                        <button class="btn btn-outline-secondary"
                                type="button"
                                disabled="@isRequestingLocation"
                                @onclick="UseCurrentLocationAsync">
                            @(isRequestingLocation ? "Obteniendo ubicación..." : "Usar ubicación actual")
                        </button>
                        @if (!string.IsNullOrEmpty(locationMessage))
                        {
                            <div class="form-text mt-2">@locationMessage</div>
                        }

                        <div class="mt-3 map-picker" @ref="mapElement"></div>
                        <div class="form-text">Haz clic en el mapa para fijar un punto exacto.</div>
                    </div>
                </div>
            </div>

            <div class="col-12 col-lg-5">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-body">
                        <h5 class="card-title">Foto principal</h5>

                        @if (!string.IsNullOrEmpty(plant.MainPhotoPath))
                        {
                            <img src="@plant.MainPhotoPath"
                                 alt="@plant.Name"
                                 class="img-fluid rounded mb-3 shadow-sm"
                                 style="max-height: 260px; object-fit: cover;" />
                        }
                        else
                        {
                            <p class="text-muted">Sin foto actual.</p>
                        }

                        <InputFile OnChange="OnImageSelected" />
                        <div class="form-text">Selecciona una nueva imagen para reemplazarla.</div>

                        @if (!string.IsNullOrEmpty(previewImage))
                        {
                            <img src="@previewImage"
                                 class="img-fluid rounded mt-3 shadow-sm"
                                 style="max-height: 260px; object-fit: cover;" />
                        }
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-4 d-flex gap-3">
            <button class="btn btn-success px-4" type="submit" disabled="@isSaving">
                @(isSaving ? "Guardando..." : "Guardar cambios")
            </button>
            <NavLink class="btn btn-outline-secondary" href="/plants">Cancelar</NavLink>
        </div>
    </EditForm>
}

@code {
    [Parameter] public int Id { get; set; }

    private Plant? plant;
    private IBrowserFile? selectedFile;
    private string? previewImage;
    private string? formError;
    private string? locationMessage;
    private string? locationSearch;
    private string? locationSearchError;
    private bool isLocationEditable;
    private bool isLoading = true;
    private bool isSaving;
    private bool isRequestingLocation;
    private readonly string[] defaultZones = { "Sala", "Comedor", "Cocina", "Dormitorio", "Estudio", "Patio", "Balcón", "Terraza", "Jardín", "Otro" };
    private readonly HashSet<string> defaultZoneSet = new(StringComparer.OrdinalIgnoreCase);
    private readonly List<string> zoneOptions = new();
    private readonly List<HomeZone> homeZones = new();
    private string? newZoneName;
    private bool showZoneManager;
    private bool zonesLoaded;
    private bool isZoneOperation;
    private string? zoneError;
    private readonly List<LocationSuggestion> locationResults = new();
    private bool isSearchingLocation;
    private ElementReference mapElement;
    private DotNetObjectReference<EditPlant>? mapDotNetRef;
    private bool mapInitialized;

    protected override async Task OnInitializedAsync()
    {
        foreach (var zone in defaultZones)
        {
            defaultZoneSet.Add(zone);
            AddZoneOption(zone);
        }

        plant = await PlantService.GetPlantAsync(Id);
        isLoading = false;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!mapInitialized && !isLoading)
        {
            mapDotNetRef ??= DotNetObjectReference.Create(this);
            var lat = plant?.Latitude ?? -5.19;
            var lon = plant?.Longitude ?? -80.63;
            mapInitialized = await Js.InvokeAsync<bool>("plantCareMap.init", mapElement, mapDotNetRef, lat, lon);
            await LoadZonesAsync();
        }
    }

    private async Task LoadZonesAsync(bool forceRefresh = false)
    {
        if (zonesLoaded && !forceRefresh)
        {
            return;
        }

        try
        {
            var zones = await HomeZoneService.GetZonesAsync();
            homeZones.Clear();
            homeZones.AddRange(zones);
            foreach (var zone in zones)
            {
                AddZoneOption(zone.Name);
            }
            zoneError = null;
        }
        catch (Exception ex)
        {
            zoneError = $"No se pudieron cargar tus ambientes: {ex.Message}";
        }
        finally
        {
            zonesLoaded = true;
            StateHasChanged();
        }
    }

    private void AddZoneOption(string? zone)
    {
        if (string.IsNullOrWhiteSpace(zone))
        {
            return;
        }

        if (!zoneOptions.Any(z => string.Equals(z, zone, StringComparison.OrdinalIgnoreCase)))
        {
            zoneOptions.Add(zone);
        }
    }

    private async Task AddCustomZoneAsync()
    {
        if (string.IsNullOrWhiteSpace(newZoneName) || isZoneOperation)
        {
            return;
        }

        var normalized = System.Globalization.CultureInfo.CurrentCulture.TextInfo.ToTitleCase(newZoneName.Trim());

        try
        {
            isZoneOperation = true;
            zoneError = null;
            var created = await HomeZoneService.AddZoneAsync(new HomeZone { Name = normalized });
            if (plant is not null)
            {
                plant.LocationArea = created.Name;
            }

            newZoneName = string.Empty;
            await LoadZonesAsync(forceRefresh: true);
        }
        catch (Exception ex)
        {
            zoneError = ex.Message;
        }
        finally
        {
            isZoneOperation = false;
        }
    }

    private async Task RemoveZoneAsync(string zone)
    {
        if (defaultZoneSet.Contains(zone) || isZoneOperation)
        {
            return;
        }

        try
        {
            isZoneOperation = true;
            zoneError = null;
            var entity = homeZones.FirstOrDefault(z => string.Equals(z.Name, zone, StringComparison.OrdinalIgnoreCase));
            if (entity is not null)
            {
                await HomeZoneService.DeleteZoneAsync(entity.Id);
            }

            zoneOptions.RemoveAll(z => string.Equals(z, zone, StringComparison.OrdinalIgnoreCase));
            await LoadZonesAsync(forceRefresh: true);
        }
        catch (Exception ex)
        {
            zoneError = ex.Message;
        }
        finally
        {
            isZoneOperation = false;
        }
    }

    private void ToggleZoneManager() => showZoneManager = !showZoneManager;

    private void ToggleLocationEditable() => isLocationEditable = !isLocationEditable;

    private async Task OnImageSelected(InputFileChangeEventArgs e)
    {
        selectedFile = null;
        previewImage = null;

        if (e.File is null)
        {
            return;
        }

        selectedFile = e.File;
        var previewFile = await selectedFile.RequestImageFileAsync("image/png", 1280, 1280);
        await using var previewStream = previewFile.OpenReadStream(maxAllowedSize: 4 * 1024 * 1024);
        using var memory = new MemoryStream();
        await previewStream.CopyToAsync(memory);
        previewImage = $"data:image/png;base64,{Convert.ToBase64String(memory.ToArray())}";
    }

    private async Task HandleValidSubmit()
    {
        if (plant is null)
        {
            return;
        }

        try
        {
            isSaving = true;
            if (selectedFile is not null)
            {
                ImageStorageService.DeleteImage(plant.MainPhotoPath);
                plant.MainPhotoPath = await ImageStorageService.SavePlantImageAsync(selectedFile);
            }

            await PlantService.UpdatePlantAsync(plant);
            Navigation.NavigateTo("/plants");
        }
        catch (Exception ex)
        {
            formError = ex.Message;
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task UseCurrentLocationAsync()
    {
        if (plant is null || isRequestingLocation)
        {
            return;
        }

        try
        {
            isRequestingLocation = true;
            var coords = await Js.InvokeAsync<GeoResult>("plantCare.getCurrentPosition");
            plant.Latitude = Math.Round(coords.Latitude, 6);
            plant.Longitude = Math.Round(coords.Longitude, 6);
            locationMessage = $"Ubicación actualizada (±{coords.Accuracy:N0} m).";

            var suggestion = await LocationLookupService.ReverseLookupAsync(coords.Latitude, coords.Longitude);
            if (suggestion is not null)
            {
                plant.LocationName = suggestion.Name;
                plant.Country = suggestion.Country;
            }

            await UpdateMapAsync();
        }
        catch (JSException jsEx)
        {
            locationMessage = $"No se pudo obtener la ubicación: {jsEx.Message}";
        }
        catch
        {
            locationMessage = "No se pudo obtener la ubicación actual.";
        }
        finally
        {
            isRequestingLocation = false;
        }
    }

    private async Task SearchLocationAsync()
    {
        if (plant is null)
        {
            return;
        }

        if (string.IsNullOrWhiteSpace(locationSearch))
        {
            locationResults.Clear();
            locationSearchError = "Ingresa el nombre de una ciudad.";
            return;
        }

        try
        {
            isSearchingLocation = true;
            locationSearchError = null;
            locationResults.Clear();
            var results = await LocationLookupService.SearchAsync(locationSearch.Trim());
            if (results.Count == 0)
            {
                locationSearchError = "No encontramos coincidencias.";
            }
            else
            {
                locationResults.AddRange(results);
            }
        }
        catch (Exception ex)
        {
            locationSearchError = ex.Message;
        }
        finally
        {
            isSearchingLocation = false;
        }
    }

    private async Task ApplyLocation(LocationSuggestion suggestion)
    {
        if (plant is null)
        {
            return;
        }

        plant.LocationName = suggestion.Name;
        plant.Country = suggestion.Country;
        plant.Latitude = Math.Round(suggestion.Latitude, 6);
        plant.Longitude = Math.Round(suggestion.Longitude, 6);
        locationMessage = $"Ubicación establecida: {suggestion.Name}, {suggestion.Country}";
        locationResults.Clear();
        locationSearch = suggestion.Name;
        await UpdateMapAsync();
    }

    private async Task UpdateMapAsync()
    {
        if (mapInitialized && plant is not null)
        {
            await Js.InvokeVoidAsync("plantCareMap.update", mapElement, plant.Latitude ?? 0, plant.Longitude ?? 0);
        }
    }

    [JSInvokable]
    public Task OnMapLocationChanged(double latitude, double longitude)
    {
        if (plant is null)
        {
            return Task.CompletedTask;
        }

        plant.Latitude = Math.Round(latitude, 6);
        plant.Longitude = Math.Round(longitude, 6);
        locationMessage = $"Coordenadas seleccionadas: {latitude:F4}, {longitude:F4}";
        StateHasChanged();
        return Task.CompletedTask;
    }

    public async ValueTask DisposeAsync()
    {
        if (mapInitialized)
        {
            await Js.InvokeVoidAsync("plantCareMap.dispose", mapElement);
        }
        mapDotNetRef?.Dispose();
    }

    private record GeoResult(double Latitude, double Longitude, double Accuracy);
}
