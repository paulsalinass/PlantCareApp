@page "/dashboard"
@rendermode InteractiveServer

@inject PlantService PlantService
@inject HomeZoneService HomeZoneService

<div class="today-header d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
    <div>
        <h1 class="mb-1 fw-semibold">Panel de ambientes</h1>
        <p class="text-muted mb-0">Observa el estado de cada zona del hogar y prioriza los cuidados.</p>
    </div>
    <NavLink class="btn btn-outline-primary" href="/zones">Configurar ambientes</NavLink>
</div>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}
else if (isLoading)
{
    <p>Cargando métricas...</p>
}
else
{
    <div class="row g-3 mb-4">
        @foreach (var card in overview)
        {
            <div class="col-12 col-md-4">
                <div class="today-summary-card @card.Css">
                    <div class="summary-icon">
                        <i class="@card.Icon"></i>
                    </div>
                    <div>
                        <p class="summary-label mb-1">@card.Title</p>
                        <h3 class="summary-title mb-0">@card.Count</h3>
                        <small class="text-muted">@card.Subtitle</small>
                    </div>
                </div>
            </div>
        }
    </div>

    <div class="row g-3">
        @foreach (var zone in zoneCards)
        {
            <div class="col-12 col-xl-6">
                <div class="history-card">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <h5 class="mb-0">@zone.Name</h5>
                            <small class="text-muted">@zone.TypeLabel</small>
                        </div>
                        <span class="badge bg-light text-dark">@($"{zone.PlantCount} planta(s)")</span>
                    </div>
                    <p class="mb-2">@zone.Highlight</p>
                    <div class="row g-2 small text-muted">
                        <div class="col-6">
                            <strong>@zone.TaskSummary</strong><br />
                            Tareas pendientes
                        </div>
                        <div class="col-6">
                            <strong>@zone.LastActivity</strong><br />
                            Último registro
                        </div>
                    </div>
                    <div class="mt-3">
                        <NavLink class="btn btn-sm btn-outline-secondary" href="@($"/plants?zone={zone.Name}")">Ver plantas</NavLink>
                    </div>
                </div>
            </div>
        }
    </div>
}

@code {
    private bool isLoading = true;
    private string? errorMessage;
    private readonly List<DashboardCard> overview = new();
    private readonly List<ZoneCard> zoneCards = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var plantsTask = PlantService.GetPlantsAsync();
            var zonesTask = HomeZoneService.GetZonesAsync();
            await Task.WhenAll(plantsTask, zonesTask);

            var plants = plantsTask.Result;
            var zones = zonesTask.Result;

            var reminders = await PlantService.GetDueRemindersAsync(DateTime.Today);

            overview.Add(new DashboardCard("Total plantas", plants.Count, "bi bi-plant", "watering", "Registradas"));
            overview.Add(new DashboardCard("Ambientes", zones.Count, "bi bi-house-heart", "care", "Espacios configurados"));
            overview.Add(new DashboardCard("Tareas hoy", reminders.Count, "bi bi-bell", "fertilizing", "Pendientes"));

            foreach (var zone in zones.OrderBy(z => z.Name))
            {
                var zonePlants = plants.Where(p => string.Equals(p.LocationArea, zone.Name, StringComparison.OrdinalIgnoreCase)).ToList();
                var zoneReminders = reminders.Where(r => string.Equals(r.Plant.LocationArea, zone.Name, StringComparison.OrdinalIgnoreCase)).ToList();

                var lastEvent = zonePlants
                    .OrderByDescending(p => p.UpdatedAt)
                    .FirstOrDefault();

                zoneCards.Add(new ZoneCard(
                    zone.Name,
                    zone.AreaType ?? "Sin tipo",
                    zonePlants.Count,
                    zoneReminders.Count == 0 ? "Sin tareas urgentes" : $"{zoneReminders.Count} tarea(s) por hacer",
                    zoneReminders.Count == 0 ? "Todo al día" : $"{zoneReminders.Count} pendientes",
                    lastEvent is null ? "Sin actividad" : lastEvent.UpdatedAt.ToLocalTime().ToString("dd MMM")
                ));
            }
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

    private record DashboardCard(string Title, int Count, string Icon, string Css, string Subtitle);
    private record ZoneCard(string Name, string TypeLabel, int PlantCount, string Highlight, string TaskSummary, string LastActivity);
}
